<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>购物车</title>
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script src="${link.contextPath}/js/jquery-2.1.3.min.js"></script>
<script type="text/javascript" src="$link.getContextPath()/js/imgLiquid-min.js"></script>
<link rel="stylesheet" href="${link.contextPath}/css/mall.css" type="text/css" />
<link rel="stylesheet" href="${link.contextPath}/css/shop-car.css" type="text/css" />
<style>
	#bg{
		display: none; position: absolute; top: 0%; left: 0%; width: 100%; height: 100%; background-color: black; z-index:1001; -moz-opacity: 0.7; opacity:.70; filter: alpha(opacity=70);
		vertical-align:middle;
	}
	#content{
		display:none;
		position: absolute; 
		top: 0%; 
		left: 10%;
		margin-left:auto;
		margin-right:auto;
		margin-top:5%;
		
		border:1px solid white;
		border-radius:5px;
		
	}
	.car-footer{
		margin-bottom:47px;
	}
	
	
</style>
</head>
<!-- 
批量删除功能 -216-3-10
-->
<body>
#parse("./common/header.vm")
	
	<div id="container">
    <div class="header">
        <a href="javascript:history.go(-1);" class="header-back btn">
			<img class="img1" src="${link.contextPath}/images/classfiy/back_n.png">
			<img class="img2" src="${link.contextPath}/images/classfiy/back_p.png">
		</a>
        <span class="shop_num">购物车(0)</span>
		<a href="javascript:" id="edit">
			<img src="${link.contextPath}/images/img/edit_n.png" />
			<!-- <img class="img2" src="images/img/edit_p.png" style="display:none" /> -->
		</a>
		<a href="javascript:" id="edit2">完成</a>
    </div>
    <form id="shopcarForm" action="${link.contextPath}/order/previewOrder" method="post">
		<input type="hidden" name="fromShopCar" value="true"/>
    #foreach($m in $supplierProducts)
	<div class="car-content">
		
		<div class="bottom-title">供应商：$m.supName</div>
		#foreach($shopCarProducts in $m.shopCarProducts)
		<div class="info-bottom" data-id="$shopCarProducts.skuID" data-productid="$shopCarProducts.productID" data-stock="$shopCarProducts.skuStock" data-limit="$shopCarProducts.limitCount">
			<input type="hidden" name="skuIds" value="${shopCarProducts.skuID}"/>
			<input type="hidden" name="buyNums" value="${shopCarProducts.skuQuality}"/>
			<input type="hidden" name="skuPrices" value="${shopCarProducts.skuPrice}"/>
			<div class="car-select">
				<a href="javascript:void(0);" class="btn option">
					<img class="img1 option-img1" src="${link.contextPath}/images/img/select_n.png" />
					<img class="img2 option-img2" src="${link.contextPath}/images/img/select_p.png" />
				</a>
			</div>
			<div class="info-bottom-img imgLiquidNotFill">
				<a href="#"><img src="$qiniu.getDownloadUrl(${shopCarProducts.imgPath})" /></a>
			</div>
			<p class="bottom-1" style="font-size:14px;">$!{shopCarProducts.productName}</p>
			<div class="botton-delete">
				<a href="#" class="btn delete"> 
					<img class="img1 option-img" src="images/img/delete_n.png">
					<img class="img2" src="images/img/delete_p.png">
				</a>
			</div>
			<p class="bottom-2">
				<!-- 如果没有skuStr 需要加个空格占一行 -->
				#if($shopCarProducts.skuStrs.isEmpty())<span>&nbsp;</span>#end
				#foreach($skuStr in $shopCarProducts.skuStrs)<span>$skuStr</span>&nbsp;#end
			</p>
			<p class="bottom-3">
				<span style="color:#F389AA;font-size:14px;" class="product_price">￥$number.format("#0.00",$math.div($shopCarProducts.skuPrice,100))</span>
				<div class="bottom-number">
					<div class="number-1">
						<a href="javascript:void(0);" class="subtract">
							<img class="img1" src="${link.contextPath}/images/img/subtract_n.png" />
							<img class="img2" src="${link.contextPath}/images/img/subtract_p.png" />
						</a>
					</div>
					<div class="number-2">$shopCarProducts.skuQuality</div>
					<div class="number-1">
						<a href="javascript:void(0);" class="add">
							<img class="img1" src="${link.contextPath}/images/img/add_n.png" />
							<img class="img2" src="${link.contextPath}/images/img/add_p.png" />
						</a>
					</div>
				</div>
			</p>
		</div>
		#end
	</div>
	#end
	</form>
	
	<div class="car-footer">
		<div class="car-footer-1 divselectall">
			<a href="javascript:" id="selectAll">
				<img class="img1 option-img1" src="${link.contextPath}/images/img/select_n.png" />
				<img class="img2 option-img2" src="${link.contextPath}/images/img/select_p.png" />
				<span class="optionAll">全选</span>
			</a>
		</div>
		<div class="car-footer-2"><span class="car-footer-3">合计：￥0.00</span></div>
		<div class="car-footer-1" style="margin-left:-8px;">
			<a href="javascript:void(0);" style="color:#fff;" class="placeOrder">结算(0)</a>
			<a href="javascript:void(0);" style="color:#fff;display:none;" class="allDel">删除</a>
		</div>
	</div>
</div>
		
		<style>.logo a{text-decoration:none;color:#666;}.logo img{vertical-align:top;}.logo .img2{display:none;}span.num{background-color: #E81959;color:#fff;font-family:Verdana;font-weight:normal;font-size:15px;padding:2px 2px;border-radius:15px;position:absolute;margin-top:-7px;margin-left:-10px;line-height:15px;width:15px;height:15px;}.logo{width:100%;height:45px;border:1px solid #cecece;box-shadow:0 0 5px #cecece;background-color:#fff;position:fixed;bottom:0;left:0;z-index:9999}.logo-main{width:100%;height:50px;}.logo-circle{display:block;width:60px;height:60px;border-radius:50%;position:absolute;background-color:#fff; border:1px solid #cecece;box-shadow:0 0 5px #cecece;z-index:99;top:-25px;left:40%;text-align:center;color:#b1b1b1}.logo-style{width:25%;height:30px;line-height:40px;text-align:center;float:left;}.logo-1{wdith:100%;height:50%;padding-top:5px;}.logo-2{wdith:100%;height:50%;line-height:35px;}.logo-1 img{width:35px;height:35px;}.car-1,.wealth-1{width:60%;height:50%;margin-left:20%;}.car-2,.wealth-2{width:60%;height:50%;margin-left:20%;}.car-1 img,.wealth-1 img{width:30px;height:30px;}</style>
		<div class='logo'><div class='logo-main'><div class='logo-home logo-style'><a href='/' class='car indexbtn'><div class='car-1'><img class='img1' src='${link.contextPath}/images/img/index/home_n.png'><img class='img2' src='${link.contextPath}/images/img/index/home_p.png'></div></a><div class='car-2'><a href='/' class='car indexbtn'><span style='font-size:12px;'>首页</span></a></div></div><div class='logo-category logo-style'><a href='/productCategory/index' class='car indexbtn'><div class='car-1'><img class='img1' src='${link.contextPath}/images/img/index/category_n.png'><img class='img2' src='${link.contextPath}/images/img/index/category_p.png'></div></a><div class='car-2'><a href='/productCategory/index' class='car indexbtn'><span style='font-size:12px;'>分类</span></a></div></div><div class='logo-car logo-style'><a href='/shop_car' class='car indexbtn'><div class='car-1'><img class='img1' src='${link.contextPath}/images/img/index/shopping_cart_p.png'><img class='img2' src='${link.contextPath}/images/img/index/shopping_cart_p.png'><span class='num'>0</span></div></a><div class='car-2'><a href='/shop_car' class='car indexbtn'><span style='font-size:12px;'>购物车</span></a></div></div><div class='logo-wealth logo-style'><a href='/user/index' class='wealth indexbtn'><div class='wealth-1'><img class='img1' src='${link.contextPath}/images/img/index/treasure_n.png'><img class='img2' src='${link.contextPath}/images/img/index/treasure_p.png'></div><div class='wealth-2'><a href='/user/index' class='car indexbtn'><span style='font-size:12px;'>个人中心</span></a></div></div></div></div>
		<script type='text/javascript'>
			$.get('/shop_car/shopcar_count',function(ret){if(ret && ret.errcode==0){$('.num').text(ret.count);}else{$('.num').text(0);}});$('.indexbtn').click(function(){if($(this).find('.img1').is(':visible')){$(this).find('.img1').hide();$(this).find('.img2').show();}else{$(this).find('.img2').hide();$(this).find('.img1').show();}});
			function choose(classs){
				$("."+classs+" a").attr("href","javascript:");
				$("."+classs+" .img1").hide();
				$("."+classs+" .img2").show();
				$("."+classs+" span:not('.num')").css("color","#E71959");
			}
			choose("logo-car");
		</script>
		
</body>
<script>
    $(function(){
    	
    	$(".imgLiquidNotFill").imgLiquid({
	        fill: false,
	        horizontalAlign: "center",
	        verticalAlign: "center"
	    });
    	
    	$(".shop_num").text("购物车("+$(".info-bottom").length+")");
    	
    	var pattern = /\d+(\.\d+)?/;
    	
    	function getNum(text){
    		var numStr = pattern.exec(text)[0];
    		return Number(parseFloat(numStr).toFixed(2));
    	}
    	
		$(".btn").click(function(){
			if($(this).find(".img1").is(":visible")){
				$(this).find(".img1").hide();
				$(this).find(".img2").show();
			}else{
				$(this).find(".img1").show();
				$(this).find(".img2").hide();
			}
		});
		
		$(".option").click(function(event){
			
			var choosedNum = parseInt(pattern.exec($(".placeOrder").text()));
			
			var info_bottom = $(this).closest(".info-bottom");
			var price  =  getNum(info_bottom.find(".product_price").text());
			var buyNum =  parseInt(info_bottom.find(".number-2").text());
			
			if($(this).find(".img1").is(":visible")){
				//减少数量
				$(".placeOrder").text("结算("+(choosedNum-1)+")");
				//减少合计
				var newTotalPrice = getNum($(".car-footer-3").text())-price*buyNum;
				$(".car-footer-3").text("合计：￥"+newTotalPrice.toFixed(2));
				
				$("#selectAll").find(".option-img1").show();
				$("#selectAll").find(".option-img2").hide();
				
			}else{
				//增加数量
				$(".placeOrder").text("结算("+(choosedNum+1)+")");
				//增加合计
				var newTotalPrice = getNum($(".car-footer-3").text())+price*buyNum;
				$(".car-footer-3").text("合计：￥"+newTotalPrice.toFixed(2));
				
			}
			
			event.stopPropagation();
			
		});
		
		$(".subtract").click(function(event){
				
				var info_bottom = $(this).closest(".info-bottom");
				
				var divTxt = $(this).parents(".number-1").siblings(".number-2");
				num = divTxt.text();
				if(num < 2){
					alert("数量已经最少");
				}else{
					num--;
					if(info_bottom.find(".option .img2").is(":visible")){
						//改变总价
						var price = getNum(info_bottom.find(".product_price").text());
						var oldTotalPrice = getNum($(".car-footer-3").text());
						$(".car-footer-3").text("合计：￥"+(oldTotalPrice-price).toFixed(2));
					}
					//改变input的内容
					$(this).closest(".info-bottom").find("input:eq(1)").val(num);
				}
				divTxt.text(num);
				$(".add").find(".img1").show();
				$(".add").find(".img2").hide();
				$(this).find(".img1").hide();
				$(this).find(".img2").show();
				
				event.stopPropagation();
				
		});
		$(".add").click(function(event){
				
				var limitCount = $(this).closest(".info-bottom").data("limit");
				var productID = $(this).closest(".info-bottom").data("productid");
				var skuStock =  $(this).closest(".info-bottom").data("stock");
				var curCount = 0;
				$(".info-bottom").each(function(){
					if($(this).data("productid")==productID){
						curCount += parseInt($(this).find(".number-2").text());
					}
				});
				console.log("curCount:"+curCount);
				if(curCount==limitCount){
					event.stopPropagation();
					return;
				}
				if(curCount==skuStock){
					event.stopPropagation();
					return;
				}
				var divTxt = $(this).parents(".number-1").siblings(".number-2");
				num = divTxt.text();
				num++;
				divTxt.text(num);
				$(".subtract").find(".img1").show();
				$(".subtract").find(".img2").hide();
				$(this).find(".img1").hide();
				$(this).find(".img2").show();
				
				var info_bottom = $(this).closest(".info-bottom");
				
				if(info_bottom.find(".option").find(".img2").is(":visible")){
					//改变总价
					var price = getNum(info_bottom.find(".product_price").text());
					var oldTotalPrice = getNum($(".car-footer-3").text());
					$(".car-footer-3").text("合计：￥"+(price+oldTotalPrice).toFixed(2));
					
				}
				//改变input的内容
				$(this).closest(".info-bottom").find("input:eq(1)").val(num);
				
				event.stopPropagation();
				
		});
		
		
		$("#edit").click(function(){
				$("#edit").hide();
				$("#edit2").show();
				$(".botton-delete").show();
				//结算隐藏  显示  删除按钮
				$(".placeOrder").hide();
				$(".allDel").show();
				$(".car-footer-3").hide();
		});
		
		$("#edit2").click(function(){
			
			$("#edit").show();
			$("#edit2").hide();
			$(".botton-delete").hide();
			//隐藏掉删除按钮    显示结算按钮
			$(".allDel").hide();
			$(".placeOrder").show();
			$(".car-footer-3").show();
			
		});
		
		$(".allDel").click(function(){
			if($(".car-content").find(".car-select").find(".img2").is(":visible")){
				if(confirm('确定要批量删除商品吗?')){
					var skuIDs = [];
					var minusPrice = 0;
					var minusNum = 0;
					
					$(".info-bottom").each(function(index,item){
						if($(this).find(".option .img2").is(":visible")){
							skuIDs.push($(this).data("id"));
						}
					});
					
					$.ajax({
						url:'${link.contextPath}/shop_car/remove_shopcar_product',
						type:'POST',
						dataType:'JSON',
						data:{"skuIDs":skuIDs},
						traditional:true,
						success:function(ret){
							if(ret.errcode==0){
								console.log("删除成功");
								$(".info-bottom").each(function(index,item){
									
									if($(item).find(".option .img2").is(":visible")){
										skuIDs.push($(this).data("id"));
										
										var price  = getNum($(item).find(".product_price").text());
										var buyNum = parseInt($(item).find(".number-2").text());
										minusPrice += price*buyNum;
										
										minusNum+=1;
										
									}
								});
								
								var originalPrice = getNum($(".car-footer-3").text());		
								var newTotalPrice = (originalPrice - minusPrice).toFixed(2);
								
								$(".car-footer-3").text("合计：￥"+newTotalPrice);
								
								//设置结算个数
								var originalNum = $(".placeOrder").text().replace("结算","").replace("(","").replace(")","");
								var newConclusion = parseInt(originalNum)-minusNum;
								$(".placeOrder").text("结算("+newConclusion+")"); 
								
								//设置标题数量
								var shop_num = parseInt($(".shop_num").text().replace("购物车","").replace("(","").replace(")",""))-minusNum;
								$(".shop_num").text("购物车("+shop_num+")");
								
								//清除选项
								$(".info-bottom").each(function(index,item){
									if($(this).find(".option .img2").is(":visible")){
										//这时再移除 才不会影响钱的计算
										var carContent = $(this).closest(".car-content");
										var skuNum = carContent.find(".info-bottom").length;
										var choosedSkuNum = 0;
										carContent.find(".option").each(function(index,item){
											if($(item).find(".img2").is(":visible")){
												skuIDs.push($(this).closest(".info-bottom").data("id"));
												choosedSkuNum++;
											}
										});
										
										if(skuNum==choosedSkuNum){
											carContent.remove();
										}else{
											$(this).remove();
										}
									}
								});
								
								$("#edit").show();
								$("#edit2").hide();
								$(".botton-delete").hide();
								$(".option-img1").show();
								$(".option-img2").hide();
								
								//把 结算显示出来
								$(".placeOrder").show();
								$(".allDel").hide();
								
								//把什么显示出来
								$(".car-footer-3").show();
							}
						}
					});
					
				}else{
					$(".img1").show();
					$(".img2").hide();
					$(".option-img1").show();
					$(".option-img2").hide();
					
					$(".car-footer-3").text("合计：￥0");
					$(".placeOrder").text("结算(0)");
				}
			}else{
				alert("请选择商品");
			}
		});
		
		

		$(".delete").click(function(event){
			var carContent = $(this).closest(".car-content");
			var skuIDs = [];
			
			/* //获得此处有几个sku
			var skuNum = carContent.find(".info-bottom").length;
			//获得此处选中几个sku
			var choosedSkuNum = 0;
			carContent.find(".option").each(function(index,item){
				if($(item).find(".img2").is(":visible")){
					skuIDs.push($(this).closest(".info-bottom").data("id"));
					choosedSkuNum++;
				}
			}); */
			
			var infoBottom = $(this).closest(".info-bottom");
			if(infoBottom.find(".option-img2").is(":visible")){
				if(confirm('确定要删除该商品吗?')){
					skuIDs.push(infoBottom.data("id"));
					console.log(skuIDs);
					 $.ajax({
						url:'${link.contextPath}/shop_car/remove_shopcar_product',
						type:'POST',
						dataType:'JSON',
						data:{"skuIDs":skuIDs},
						traditional:true,
						success:function(ret){
							
							if(ret.errcode==0){
								var price  = getNum(infoBottom.find(".product_price").text());
								var buyNum = infoBottom.find(".number-2").text();
								
								
								var originalPrice = getNum($(".car-footer-3").text());
								var newTotalPrice = (originalPrice - price*buyNum).toFixed(2);
								$(".car-footer-3").text("合计：￥"+newTotalPrice);
								
								//改变结算数量
								var originalNum = $(".placeOrder").text().replace("结算","").replace("(","").replace(")","");
								var newConclusion = parseInt(originalNum)-1;
								$(".placeOrder").text("结算("+newConclusion+")"); 
								
								var shop_num = parseInt($(".shop_num").text().replace("购物车","").replace("(","").replace(")",""))-1;
								$(".shop_num").text("购物车("+shop_num+")");
								
								//清除该item
								infoBottom.remove();
								
								if(carContent.find(".info-bottom").length==0){
									carContent.remove();
								}
								
							}else{
								alert("删除失败，请重新尝试");
							}
							
						}
					}); 
				}else{
					infoBottom.find(".option-img2").hide();
					infoBottom.find(".option-img1").show();
				}
			}else{
				alert("对不起，请先选择删除的商品");
			}
			event.stopPropagation();
			setTimeout(function () {
				$(".delete").find(".img2").hide();
				$(".delete").find(".img1").show();
			 }, 50);
		});
		
		$("#selectAll").click(function(){
			if($(this).find(".option-img1").is(":visible")){
				var addPrice = 0;
				$(".option-img1").hide();
				$(".option-img2").show();
				//改变结算 的数量
				$(".placeOrder").text("结算("+$(".info-bottom").length+")");
				//改变合计的金额
				$(".info-bottom").each(function(index,item){
					var price  = getNum($(this).find(".product_price").text());
					var buyNum = parseInt($(this).find(".number-2").text());
					addPrice += price*buyNum;
				});
				$(".car-footer-3").text("合计：￥"+addPrice.toFixed(2));
				
			}else{
				$(".option-img1").show();
				$(".option-img2").hide();
				//改变结算 的数量
				$(".car-footer div:eq(2)").find('a:eq(0)').text("结算(0)");
				//改变合计的金额
				$(".car-footer-3").text("合计：￥0.00");
			}
			
		});
		
		//点击结算
		$(".placeOrder").click(function(){
			
			var choosedNum = parseInt(pattern.exec($(".placeOrder").text()));
			if(choosedNum==0){
				alert("您还未选择要购买的商品");
			}else{
				$(".info-bottom").each(function(index,item){
					if(!$(this).find(".option .img2").is(":visible")){
						$(this).find("input").remove();
					}
				});
				
				/*
				$.ajax({
					url:"${link.contextPath}/product/check-limit",
					type:"POST",
					data:$("#shopcarForm").serialize(),
					dataType:"json",
					success:function(ret){
						console.log(ret);
						if(ret && ret.errcode==0){
							
						}else if(ret && ret.errcode && ret.errcode!=0){
							
						}else{
						
						}
					}
				});
				*/
				//修改 等清理完了再 提交表单
				$("#shopcarForm").submit();
			}
			
		});
		
		$(".info-bottom").click(function(){
			location.href="${link.contextPath}/product/product_detail?productID="+$(this).data("productid");
		});
		
	});
</script>
</html>
 
