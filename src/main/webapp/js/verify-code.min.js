VerifyCodePage=Ariel.extend(Page,{_COUTER_DOWN_SECONDS:90,_txtCardNo:null,_verifyField:null,_verfyFieldCloseBtn:null,_counterBtn:null,_nextBtn:null,_txtValidationCode:null,_crossPageData:null,_payAction:null,_sendVerifyCodeAction:null,_payType:null,_tid:null,_parameters:null,_finishData:null,init:function(){var a=this;VerifyCodePage.__super__.init.call(a),a.initComponent(),a.initData(),a._startCountingDown()},initEvent:function(){var a=this;VerifyCodePage.__super__.initEvent.call(a),a._verifyField.unbind("input keyup.txtValidationCode").bind("input keyup.txtValidationCode",function(){a._txtValidationCode.isValid()?a._nextBtn.removeClass("NEXT_BTN_DISABLED"):a._nextBtn.addClass("NEXT_BTN_DISABLED");var b=a._verifyField.val();b&&b.length>0&&a._txtValidationCode._wrapper.find(".textfile-reset").removeClass("textfile-reset-hide")}),a._nextBtn.bind("tap",function(){a.startPay.call(a)}),a._counterBtn.bind("tap",function(){a._sendVerifyCode.call(a)}),a.renderInput(),a._displayHeader(),$(window).resize(function(){a.renderInput()}),a._pageScroller.refresh(),a._sendMonitorData()},startPay:function(){var a=this;!a._nextBtn.hasClass("NEXT_BTN_DISABLED")&&a._verifyField.val()&&(Ariel.mpingEvent("JDCashierFastPaySecurityCode_Sure",location.href),ariel.Components.Loading.show(),Common.Net.ajax({url:a._payAction,type:"POST",data:a._getPayParameters(),success:function(b){if(a._isBlankNotePayType())return void a._processBlankNotePayResult(b);if(b.success){if("154"==a._finishData.agencyCode||"157"==a._finishData.agencyCode)return ariel.Components.Loading.hide(),void a._processFinishData(b);a._pollPayResult(b.asyncTxnSequenceId)}else ariel.Components.Loading.hide(),ariel.Components.Pop.show(b.info)}}))},_isBlankNotePayType:function(){var a=this;return"blank-note"==a._payType},_saveClientEntranceData:function(a){var b=this;b._isBlankNotePayType()&&b._validateAcrossPagesBlankNoteStageData(a),ariel.Courier.add(Common.DataKeys.ACROSS_PAGES_CLIENT_ENTRANCE_DATA,JSON.stringify({showIcon:a.showIcon?"1":"0",showMIcon:a.showMIcon?"1":"0"}))},_validateAcrossPagesBlankNoteStageData:function(a){var b={isValid:1,planText:a.baiTiaoPayResult.planText?a.baiTiaoPayResult.planText:"30天免息",price:a.baiTiaoPayResult.price?a.baiTiaoPayResult.price:"0",total:a.baiTiaoPayResult.total?a.baiTiaoPayResult.total:"0",stage:a.baiTiaoPayResult.installmentNum?a.baiTiaoPayResult.installmentNum:"1",repayDate:a.baiTiaoPayResult.repayDate};ariel.Courier.add(Common.DataKeys.ACROSS_PAGES_BLANK_NOTE_STAGE_DATA,JSON.stringify(b))},_processBlankNotePayResult:function(a){var b=this;ariel.Components.Loading.hide(),1==a.baiTiaoPayResult.isSuccess&&1==a.baiTiaoPayResult.txnStatus?b._processFinishData(a):(Ariel.mpingEvent("JDCashierNotes_Sure",location.href,"0"),ariel.Components.Pop.show(a.baiTiaoPayResult.info))},_pollSendResult:function(a,b){var c,d=this;if(b){if(3e3==b)b=5e3;else if(5e3==b)b=1e4;else if(1e4==b)return d._stopCouterDown(),Ariel.mpingEvent("JDCashierNotes_Sure",location.href,"0"),void ariel.Components.Pop.show("短信发送失败，请重发")}else b=3e3;c=setTimeout(function(){Common.Net.ajax({url:"tradeStatus.action",type:"POST",data:{asyncTxnSequenceId:a,bindCardType:"1"},success:function(e){if(e.success){var f=Common.JSON.parse(e.originJson);1!=f.txnStatus&&d._pollSendResult(a,b)}else d._stopCouterDown(),ariel.Components.Pop.show(e.info);clearTimeout(c)}})},b)},_pollPayResult:function(a,b){var c,d=this;if(b){if(3e3==b)b=5e3;else if(5e3==b)b=1e4;else if(1e4==b)return Ariel.mpingEvent("JDCashierNotes_Sure",location.href,"0"),ariel.Components.Loading.hide(),void ariel.Components.Pop.show(data.info)}else b=3e3;c=setTimeout(function(){var e=d._parameters,f={};for(var g in e)f[g]=e[g];f.asyncTxnSequenceId=a,f.bindCardType="1",Common.Net.ajax({url:"tradeStatus.action",type:"POST",data:f,success:function(e){if(e.success){var f=Common.JSON.parse(e.originJson);if(1!=f.txnStatus)d._pollPayResult(a,b);else{var g=Common.JSON.parse(ariel.Courier.get(Common.DataKeys.ACROSS_PAGES_PAY_BUSINESS_DATA));82==g.orderType&&e.redirectUrl?window.location.href=e.redirectUrl:d._processFinishData(e),ariel.Components.Loading.hide()}}else Ariel.mpingEvent("JDCashierNotes_Sure",location.href,"0"),ariel.Components.Loading.hide(),ariel.Components.Pop.show(e.info);clearTimeout(c)}})},b)},_processFinishData:function(a){var b=this;Ariel.mpingEvent("JDCashierNotes_Sure",location.href,"1"),setTimeout(function(){b._isBlankNotePayType()&&b._validateAcrossPagesBlankNoteStageData(a);var c=Ariel.parseGetParameters();c.payId&&c.appId||(c=Common.JSON.parse(ariel.Courier.get(Common.DataKeys.ACROSS_PAGES_PAY_REQUEST_DATA))),window.Common.FinishPage.go(c)},200)},_getPayParameters:function(){var a=this,b=a._verifyField.val();return a._isBlankNotePayType()?a._parameters.verifyCode=b:a._parameters.phoneCode=b,a._parameters},_sendVerifyCode:function(){var a=this;a._counterBtn.hasClass("COUNTER_DOWN_ENABLE")&&(Ariel.mpingEvent("JDCashier_GetAgain",location.href),a._startCountingDown(),a._isBlankNotePayType()?a._resendMessageRequest():a._resendMessageRequest(function(b){a._pollSendResult(b)}))},_resendMessageRequest:function(a){var b=this,c="getPhoneCodeRegister.action",d=b._parameters;b._isBlankNotePayType()?(c="baiTiaoSendCode.action",delete d.verifyCode):(c="getPhoneCodeRegister.action",d.phoneCodeFunc=b._getMessageActionParameter,delete d.phoneCode),Common.Net.ajax({url:c,type:"POST",data:d,success:function(c){if(c.success)a&&a.call(b,c.asyncTxnSequenceId);else{b._stopCouterDown();var d=null;d=b._isBlankNotePayType()?c.baiTiaoPayResult.info:c.info,ariel.Components.Pop.show(d)}}})},_startCountingDown:function(){var a=this,b=a._COUTER_DOWN_SECONDS;a._counterBtn.removeClass("COUNTER_DOWN_ENABLE"),a._tid=setInterval(function(){0>=b?a._stopCountingDown():a._counterBtn.text(b--+"秒")},1e3)},_stopCountingDown:function(){var a=this;a._counterBtn.addClass("COUNTER_DOWN_ENABLE"),a._counterBtn.text("重新获取"),clearInterval(a._tid)},initComponent:function(){var a=this;ariel=window.Ariel,a._verifyField=$(".VERIFY_CODE_CONTENT"),a._counterBtn=$(".VERIFY_CODE .COUNTER_DOWN"),a._verfyFieldCloseBtn=$(".VERIFY_CODE .close-btn"),a._nextBtn=$(".VERIFY_CODE_NEXT"),a._txtValidationCode=new ariel.Components.Textfile({selector:".VERIFY_CODE .VERIFY_CODE_INPUT",pattern:/^\d{6}$/,tap:!1}),a._txtValidationCode._wrapper.find(".textfile-reset1").unbind("tap").bind("tap",function(){a._txtValidationCode._resetInput()}),a._txtValidationCode._displayReset=function(){0==a._txtValidationCode._wrapper.find(".textfile-input").val().length?a._txtValidationCode._wrapper.find(".textfile-reset1").addClass("textfile-reset-hide"):a._txtValidationCode._wrapper.find(".textfile-reset1").removeClass("textfile-reset-hide"),a._nextBtn.addClass("NEXT_BTN_DISABLED")},$(".VERIFY_CODE_FORM").show()},_formatTel:function(a){return a.replace(/^(\d{3})(\d+)(\d{4})$/,"$1****$3")},initData:function(){var a=this,b=Common.JSON.parse(Ariel.Courier.get(Common.DataKeys.ACROSS_PAGES_VERIFY_CODE_DATA));a._payType=b.payType,a._parameters=b.params,a._finishData=b.finishData,a._isBlankNotePayType()?(a._payAction="baiTiaoPayResult.action",a._sendVerifyCodeAction="baiTiaoSendCode.action"):b.isNewCard?(a._getMessageActionParameter="getVerifyCode",a._payAction="doRegister.action"):(a._getMessageActionParameter="getVerifyCodeSecondPay",a._payAction="pay.action"),$(".MOBILE_VALIDATION_TIP strong").text(a._formatTel(b.tel))},renderInput:function(){var a=$(".VERIFY_CODE_FORM").width();$(".VERIFY_CODE_INPUT").css("width",a-160+"px")}});