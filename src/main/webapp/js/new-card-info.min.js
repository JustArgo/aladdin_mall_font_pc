!function(a){var b=a.Ariel;a.NewCardInfoPreloadTextfile=b.extend(b.Components.Textfile,{_initEvent:function(){var a=this;NewCardInfoPreloadTextfile.__super__._initEvent.call(a)},isValid:function(){var a=this,b=a._wrapper.find(".textfile-input");return 1==parseInt(b.attr("data-use-preload"))&&""!=b.val()?!0:NewCardInfoPreloadTextfile.__super__.isValid.call(a)},_resetInput:function(){var a=this;NewCardInfoPreloadTextfile.__super__._resetInput.call(a),a._wrapper.find(".textfile-input").attr("data-use-preload",0)}})}(window),NewCardInfoPage=Ariel.extend(Page,{_CARD_KNOWN_STATE_KNOWED:"knowed",_CARD_KNOWN_STATE_UNKNOW:"unknow",_banks:null,_cardNo:null,_cardState:null,_txtCreditCardNo:null,_txtSavingsCardNo:null,_txtHolderName:null,_txtIdCard:null,_txtPhone:null,_txtSafeCode:null,_txtValidDate:null,_userInfo:null,_isUserRealInfo:"N",init:function(){var a=this;NewCardInfoPage.__super__.init.call(a),a._checkCardNo()},initEvent:function(){var a=this;NewCardInfoPage.__super__.initEvent.call(a);var b="ontouchend"in document?"touchend":"click";$(".JS-page-ct .unknow-card-wrap .list-link").bind(b,function(b){var c=a._banks.savingsCardBanks;$(".credit").hasClass("checked")&&(c=a._banks.creditCardBanks);var d=$(".choose-bank").attr("acronym"),e=$(".choose-bank").attr("agencyCode");Ariel.Components.BankList.setConfig({onEnter:function(b){for(var c in b)$(".choose-bank").attr(c,b[c]);$(".choose-bank .card-info").html(b.name),$(".choose-bank .card-info").addClass("bank-name-valid"),"false"!=b.isVaildCVV2&&$(".unknow-card-wrap .credit").hasClass("checked")?$(".JS-page-ct .unknow-card-wrap .safe-code-wrap").show():$(".JS-page-ct .unknow-card-wrap .safe-code-wrap").hide(),"BCOM"==b.acronym&&$(".credit").hasClass("checked")?a._showBCOMorNot(!0):a._showBCOMorNot(!1),a._pageScroller.refresh()},_displayName:function(a){return a.name},selectData:{acronym:d,agencyCode:e},dataModel:["acronym","name","agencyCode","isVaildCVV2"],data:c,title:"请选择卡片所属银行"}),Ariel.Components.Loading.show(),setTimeout(function(){Ariel.Components.Loading.hide(),Ariel.Components.BankList.show()},320),b.preventDefault()}),$(".JS-page-ct .expire-tip").bind("tap",function(){Common.Components.HelpDialog.show(Common.Components.HelpDialog.HELP_FOR_EXPIRE)}),$(".JS-page-ct .safe-code-tip").bind("tap",function(){Common.Components.HelpDialog.show(Common.Components.HelpDialog.HELP_FOR_SAFE_CODE)}),$(".JS-page-ct .savings-card-wrap .cardId-tip").bind("tap",function(){Common.Components.CommonDialog.show("此身份证号仅用于京东支付信息<br/>验证，不由银行验证")}),$(".JS-page-ct .savings-card-wrap .phone-tip").bind("tap",function(){Common.Components.CommonDialog.show("此手机号仅用于京东支付身份<br/>验证，不由银行验证")}),$(".CARD_TYPE .type-radio").bind("tap",function(b){var c=$(b.target),d=$(b.target);if(c.hasClass("card-type-name")&&(d=c.parent()),$(".CARD_TYPE .type-radio").removeClass("checked"),d.addClass("checked"),a._resetChooseBank(),d.hasClass("saving"))$(".credit-card-list-item").hide(),a._showBCOMorNot(!1);else if(d.hasClass("credit")){$(".credit-card-list-item").show();var e=$(".unknow-card-wrap .choose-bank").attr("acronym");"BCOM"==e?a._showBCOMorNot(!0):a._showBCOMorNot(!1)}}),$(".JS-page-ct .next").bind("tap",function(){if(a._cardKnownState==a._CARD_KNOWN_STATE_UNKNOW){var b=$(".unknow-card-wrap .card-no .textfile-input").val();if(!b||!a._txtCardNo._pattern.test(b.replace(/ /g,"")))return void Ariel.Components.Pop.show("请输入正确的银行卡号");if(!$(".JS-page-ct .unknow-card-wrap .choose-bank").attr("name"))return void Ariel.Components.Pop.show("请选择银行")}if(a._cardKnownState==a._CARD_KNOWN_STATE_KNOWED){creditWrapper=$(".JS-page-ct .knowed-card-wrap");var c=$(".JS-page-ct .knowed-card-wrap .card");if("2"==c.attr("cardType")){if(!a._txtValidDate._pattern.test($(".knowed-card-wrap .valid-date .textfile-input").val()))return void Ariel.Components.Pop.show("请输入正确的有效期");var d=c.attr("isVaildCVV2");if("false"!=d&&!a._txtSafeCode.isValid())return void Ariel.Components.Pop.show("请输入正确的安全码")}}else if(a._cardKnownState==a._CARD_KNOWN_STATE_UNKNOW&&$(".JS-page-ct .CARD_TYPE .credit").hasClass("checked")){if(!a._txtValidDate.isValid())return void Ariel.Components.Pop.show("请输入正确的有效期");var d=$(".JS-page-ct .unknow-card-wrap .choose-bank").attr("isVaildCVV2");if("false"!=d&&!a._txtSafeCode.isValid())return void Ariel.Components.Pop.show("请输入正确的安全码")}if(!a._txtHolderName.isValid())return void Ariel.Components.Pop.show("请输入正确的姓名");if(!a._txtIdCard.isValid())return void Ariel.Components.Pop.show("请输入正确的身份证号");if(!a._txtPhone.isValid())return void Ariel.Components.Pop.show("请输入正确的手机号");if(!$(".readAndAgree").hasClass("checked"))return $(".COM_MASK").show(),void $(".iKnowIt-wrap").show();Ariel.mpingEvent("JDCashierFastPayAddNewCard_Pay",location.href);var e=a._getSaveData();Ariel.Components.Loading.show(),a._saveData(a._getSaveData(),function(){a._sendMessageRequest(function(b){a._pollSendResult(b,function(){Ariel.Components.Loading.hide(),"N"==a._isUserRealInfo?a._storeUserInfo():Ariel.Courier.remove(Common.DataKeys.NEW_CARD_INFO_DATA);var b={tel:e.phone,isNewCard:!0,finishData:{agencyCode:e.agencyCode},params:{}};Ariel.Courier.add(Common.DataKeys.ACROSS_PAGES_VERIFY_CODE_DATA,JSON.stringify(b)),window.location.href="verify-code.html"})})})}),$(".readAndAgree").bind("tap",function(){var a=$(this);a.hasClass("checked")?a.removeClass("checked"):a.addClass("checked")}),$(".relevantAgreement").bind("tap",function(){window.location.href="http://jrinfo.jd.com/html/servicepro.html"}),$(".iKnowIt").bind("click",function(){$(".iKnowIt-wrap").hide(),$(".COM_MASK").hide(),$(".readAndAgree").removeClass("checked"),$(".readAndAgree").addClass("checked")}),$(".savings-card-wrap .use-other-info").bind("tap",function(b){var c=$(b.target).html();c.indexOf("使用其他信息")>=0?(a._isUserRealInfo="N",a._txtIdCard._resetInput(),a._txtHolderName._resetInput(),a._setSavingInfoReadonly(!1),$(b.target).html("使用实名信息")):(a._isUserRealInfo="Y",a._setSavingInfoReadonly(!0),$(b.target).html("使用其他信息"),a._txtIdCard._resetInput(),a._txtHolderName._resetInput(),a._userInfo&&a._fillUserInfo(a._userInfo))}),a._sendMonitorData()},_showBCOMorNot:function(a){a?$(".savings-card-wrap .BCOM").show():$(".savings-card-wrap .BCOM").hide()},_fixedIOS7Only:function(){var a=window.navigator.userAgent;/iPhone\ OS\ 7/.test(a)&&$(".COMM_BACK_BTN").focus()},_resetChooseBank:function(){$(".choose-bank").removeAttr("acronym"),$(".choose-bank").removeAttr("agencyCode"),$(".choose-bank").removeAttr("isVaildCVV2"),$(".choose-bank").removeAttr("name"),$(".choose-bank .card-info").removeClass("bank-name-valid"),$(".choose-bank .card-info").html("请选择卡片所属银行")},_saveData:function(a,b){var c=this;Common.Net.ajax({url:"save.action",type:"POST",data:{cardNo:a.cardNo,phoneCodeFunc:"getVerifyCode",phone:a.phone,holderName:a.holderName,holderId:a.idCard,holderIdType:0,validDate:a.validDate,cvv2:a.safeCode,cardType:a.cardType,agencyCode:a.agencyCode,bankNo:a.acronym,bankName:a.bankName},success:function(a){a.success?b&&b.call(c):(Ariel.Components.Loading.hide(),Ariel.Components.Pop.show("数据保存失败，请重试"))}})},_sendMessageRequest:function(a){var b=this;Common.Net.ajax({url:"getPhoneCodeRegister.action",type:"POST",data:{phoneCodeFunc:"getVerifyCode"},success:function(c){c.success?(Ariel.mpingEvent("JDCashierFastPayAddNewCard_Pay",location.href,"1_"+b._isUserRealInfo),a&&a.call(b,c.asyncTxnSequenceId)):(Ariel.mpingEvent("JDCashierFastPayAddNewCard_Pay",location.href,"0_"+b._isUserRealInfo),Ariel.Components.Loading.hide(),Ariel.Components.Pop.show(c.info))}})},_pollSendResult:function(a,b,c){var d,e=this;if(c){if(3e3==c)c=5e3;else if(5e3==c)c=1e4;else if(1e4==c)return Ariel.Components.Loading.hide(),void Ariel.Components.Pop.show("短信发送失败，请重发")}else c=3e3;d=setTimeout(function(){Common.Net.ajax({url:"tradeStatus.action",type:"POST",data:{asyncTxnSequenceId:a,bindCardType:"1"},success:function(f){if(f.success){var g=Common.JSON.parse(f.originJson);1!=g.txnStatus?e._pollSendResult(a,b,c):b&&b.call(e)}else Ariel.Components.Loading.hide(),Ariel.Components.Pop.show(f.info);clearTimeout(d)}})},c)},_getSaveData:function(){var a=this,b={};if(b.phone=$(".JS-page-ct .phone .textfile-input").val(),b.holderName=$(".JS-page-ct .holder-name .textfile-input").val(),b.safeCode=$(".JS-page-ct .safe-code .textfile-input").val()?$(".JS-page-ct .safe-code .textfile-input").val():"123",b.validDate=$(".JS-page-ct .valid-date .textfile-input").val(),b.idCard=$(".JS-page-ct .id-card .textfile-input").val(),b.validDate=b.validDate||"",b.validDate&&(b.validDate=b.validDate.replace("/","")),a._cardKnownState==a._CARD_KNOWN_STATE_KNOWED){var c=$(".JS-page-ct .knowed-card-wrap .bank"),d=$(".JS-page-ct .knowed-card-wrap .card");b.agencyCode=c.attr("agencyCode"),b.bankName=c.attr("bankName"),b.acronym=c.attr("acronym"),b.cardNo=d.attr("cardNo"),b.cardType=d.attr("cardType")}else if(a._cardKnownState==a._CARD_KNOWN_STATE_UNKNOW){var e=$(".JS-page-ct .unknow-card-wrap .choose-bank");b.agencyCode=e.attr("agencyCode"),b.bankName=e.attr("name"),b.acronym=e.attr("acronym"),b.cardNo=$(".JS-page-ct .card-no .textfile-input").val().toString().replace(/ /g,"");var f=$(".JS-page-ct .unknow-card-wrap .CARD_TYPE .saving").hasClass("checked")?"1":"2";b.cardType=f}return b},_checkCardNo:function(){var a=this;try{a._banks=Common.JSON.parse(Ariel.Storage.get(Common.DataKeys.CACHE_PAY_BANKS_DATA));var b=Common.JSON.parse(Ariel.Courier.get(Common.DataKeys.ACROSS_PAGES_PAY_REQUEST_DATA));a._cardNo=b.cardNo}catch(c){return void Ariel.Components.Pop.show("数据获取失败，请重试")}return a._banks&&a._cardNo?(Ariel.Components.Loading.show(),void Common.Net.ajax({url:"getUserRecentCardInfo.action",type:"POST",data:{},success:function(b){b&&b.success&&b.cardInfoMap?(a._isUserRealInfo="Y",a._userInfo=a._formatUserInfo(Common.JSON.parse(b.cardInfoMap)),a._userInfo&&a._userInfo.holderName&&a._userInfo.idCard?(Ariel.Courier.remove(Common.DataKeys.NEW_CARD_INFO_DATA),a._fillUserInfo(a._userInfo)):(a._isUserRealInfo="N",$(".use-other-info").remove(),a._setSavingInfoReadonly(!1))):(a._isUserRealInfo="N",$(".use-other-info").remove(),a._setSavingInfoReadonly(!1)),Common.Net.ajax({url:"cardBin.action",type:"POST",data:{cardNo:a._cardNo},success:function(b){if(Ariel.Components.Loading.hide(),b.success&&b.bankNo?(Ariel.mpingEvent("JDCashierFastPayAddNewCard_Next",location.href,"1"),a._initKnowedCard(b)):(Ariel.mpingEvent("JDCashierFastPayAddNewCard_Next",location.href,"0"),a._initUnknowCard()),"N"==a._isUserRealInfo){a._txtHolderName._resetInput(),a._txtIdCard._resetInput();var c=Common.JSON.parse(Ariel.Courier.get(Common.DataKeys.NEW_CARD_INFO_DATA));c&&a._setUserInfo(c)}a._pageScroller.refresh()}})}})):void Ariel.Components.Pop.show("数据获取失败，请重试")},_setSavingInfoReadonly:function(a){a?($(".savings-card-list-item").find(".holder-name").find(".textfile-input").attr("readonly","readonly"),$(".savings-card-list-item").find(".id-card").find(".textfile-input").attr("readonly","readonly")):$(".savings-card-list-item").find(".textfile-input").removeAttr("readonly")},_formatUserInfo:function(a){return a?{holderName:a.holderName,idCard:a.holderId}:void 0},_fillUserInfo:function(a){$(".JS-page-ct .holder-name .textfile-input").val(a.holderName),$(".JS-page-ct .holder-name .textfile-input").attr("data-use-preload","1"),$(".JS-page-ct .id-card .textfile-input").val(a.idCard),$(".JS-page-ct .id-card .textfile-input").attr("data-use-preload","1")},_setUserInfo:function(a){var b=this;a&&(a.name&&$(".JS-page-ct .holder-name .textfile-input").val(a.name),a.idCard&&$(".JS-page-ct .id-card .textfile-input").val(a.idCard),a.phone&&$(".JS-page-ct .phone .textfile-input").val(a.phone),b._txtIdCard.refresh(),b._txtPhone.refresh(),b._txtHolderName.refresh())},_storeUserInfo:function(){var a=$(".JS-page-ct .holder-name .textfile-input").val(),b=$(".JS-page-ct .id-card .textfile-input").val(),c=$(".JS-page-ct .phone .textfile-input").val(),d={name:a,idCard:b,phone:c};Ariel.Courier.add(Common.DataKeys.NEW_CARD_INFO_DATA,JSON.stringify(d))},_initKnowedCard:function(a){var b=this,c=b._formatCardData(a);$(".JS-page-ct .unknow-card-wrap").remove(),b._initTextInput(),b._initCardInfo(c),c&&"BCOM"==c.acronym&&"2"==c.cardType?b._showBCOMorNot(!0):b._showBCOMorNot(!1),$(".JS-page-ct .next").css("display","block"),b._cardKnownState=b._CARD_KNOWN_STATE_KNOWED},_initTextInput:function(){var a=this;a._txtCardNo=new Ariel.Components.Textfile({selector:".JS-page-ct .card-no",pattern:/^\d{15,20}$/}),a._txtSafeCode=new Ariel.Components.Textfile({selector:".JS-page-ct .safe-code",pattern:/^\d{3}$/}),a._txtValidDate=new Ariel.Components.Textfile({selector:".JS-page-ct .valid-date",pattern:/\d{2}\/\d{2}/}),$(a._txtValidDate._wrapper).find(".textfile-input").bind("keyup",function(a){var b=$(a.target).val();8!=a.keyCode&&b&&2==b.length&&$(a.target).val(b+"/")}),a._txtHolderName=new NewCardInfoPreloadTextfile({pattern:/.{2,}/,selector:".JS-page-ct .holder-name"}),a._txtIdCard=new NewCardInfoPreloadTextfile({selector:".JS-page-ct .id-card",pattern:/^\w{15,18}$/}),$(a._txtIdCard._wrapper).find(".textfile-input").bind("keyup",function(a){var b=$(a.target).val();b&&$(a.target).val(b.toUpperCase())}),a._txtPhone=new Ariel.Components.Textfile({selector:".JS-page-ct .phone",pattern:/^\d{8,12}$/})},_formatCardData:function(a){var b=this,c=a.bankNo,d=a.cardType,e=b._getisVaildCVV2(c,d);return{cardNo:b._cardNo,agencyCode:b._getAgencyCode(c,d),bankName:b._getBankName(c,d),bankIcon:a.bankIcon,acronym:c,isVaildCVV2:e?e:"true",cardTypeName:b._getCardTypeName(d),cardType:d}},_getAgencyCode:function(a,b){return this._getBankInfo(a,b,"agencyCode")},_getBankName:function(a,b){return this._getBankInfo(a,b,"name")},_getisVaildCVV2:function(a,b){return this._getBankInfo(a,b,"isVaildCVV2")},_getBankInfo:function(a,b,c){var d=this,e=[];switch(parseInt(b)){case 1:e=d._banks.savingsCardBanks;break;case 2:e=d._banks.creditCardBanks}for(var f=e.length-1;f>=0;f--){var g=e[f];if(g.acronym==a)return g[c]}},_getCardTypeName:function(a){var b;switch(parseInt(a)){case 1:b="储蓄卡";break;case 2:b="信用卡"}return b},_initCardInfo:function(a){var b=this,c=$(".JS-page-ct .knowed-card-wrap .bank"),d=$(".JS-page-ct .knowed-card-wrap .card");$(".JS-page-ct .knowed-card-wrap .bank-icon").attr("src",a.bankIcon),c.text(a.bankName+"（"+a.cardTypeName+"）"),c.attr("agencyCode",a.agencyCode),c.attr("bankName",a.bankName),c.attr("acronym",a.acronym),c.attr("isVaildCVV2",a.isVaildCVV2),d.text(b._formatCardNo(a.cardNo)),d.attr("cardNo",a.cardNo),d.attr("cardType",a.cardType),d.attr("isVaildCVV2",a.isVaildCVV2),"2"==a.cardType?($(".JS-page-ct .knowed-card-wrap .credit-card-list-item").show(),"false"==a.isVaildCVV2&&$(".JS-page-ct .knowed-card-wrap .safe-code-wrap").remove()):$(".JS-page-ct .knowed-card-wrap .credit-card-list-item").remove(),$(".JS-page-ct .knowed-card-wrap").show(),$(".JS-page-ct .savings-card-wrap").show()},_formatCardNo:function(a){for(var b,a=a+"",c=[],d=0;4==(b=a.substr(d,4)).length;)c.push(b),d+=4;return c.push(b),c.join(" ")},_initUnknowCard:function(){var a=this;a._initUnknowCardNo(),a._initUnknowSaveingsCardForm(),a._cardKnownState=a._CARD_KNOWN_STATE_UNKNOW},_initUnknowCardNo:function(){var a=this;$(".JS-page-ct .knowed-card-wrap").remove(),a._initTextInput(),$(".JS-page-ct .card-no .textfile-input").val(a._formatCardNo(a._cardNo)),a._showBCOMorNot(!1),a._txtCardNo.refresh()},_initUnknowSaveingsCardForm:function(){$(".JS-page-ct .unknow-card-wrap").show(),$(".JS-page-ct .savings-card-wrap").show(),$(".JS-page-ct .next").css("display","block")}});